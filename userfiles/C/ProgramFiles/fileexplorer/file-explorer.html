<head>
    <meta name="title" content="Explorer" />
    <meta name="iconLocation" content="C/OperatingSystem/Icons/ThijmenOsFileExplorer.svg" />
    <script src="https://code.jquery.com/jquery-3.6.0.js">
    </script>
    <script src="../operatingSystemApi.js"></script>
    <script src="./filetypes.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div class="content-wrapper">
        <div id="right-click-menu">
            <div class="right-click-menu-option" onclick="newUserFile('file')">New file</div>
            <div class="right-click-menu-option" onclick="newUserFile('folder')">New folder</div>
            <div class="right-click-menu-option" onclick="deleteSelectedFile()">Delete</div>
        </div>
        <div class="navigation-header">
            <img alt="back" id="back-arrow"
                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjRweCIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHJvbGU9ImltZyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImFycm93TGVmdEljb25UaXRsZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZmlsbD0ibm9uZSIgY29sb3I9IiMwMDAwMDAiPiA8dGl0bGUgaWQ9ImFycm93TGVmdEljb25UaXRsZSI+QXJyb3cgTGVmdDwvdGl0bGU+IDxwYXRoIGQ9Ik05IDZsLTYgNiA2IDYiLz4gPHBhdGggZD0iTTIxIDEySDQiLz4gPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMyAxMmgxIi8+IDwvc3ZnPg==" />
            <input type="text" class="file-path" id="file-path" readonly>
        </div>
        <div class="main-explorer-content">
            <div class="side-panel">
                <div class="search-section">
                    <p>Search:</p>
                    <input type="text" id="search-file">
                </div>
                <div class="quick-access">
                    <span>Documents</span>
                    <span>Images</span>
                    <span>Desktop</span>
                </div>
            </div>
            <div class="main-files" id="main-files">
            </div>
        </div>
    </div>
</body>

<script id="os-class-element" data-id="Explorer">
    let os = new OS();
    let pathHistory = [""]
    let explorerMode = "openFile"
    let target;
    const contextMenu = $("#right-click-menu");
    const scope = $("#main-files");
    let selectedFile = {
        path: "",
        ext: "",
    };

    getDirs()

    scope.on("contextmenu", (event) => {
        event.preventDefault();

        const { clientX: mouseX, clientY: mouseY } = event;

        contextMenu.css("top", `${mouseY}px`);
        contextMenu.css("left", `${mouseX}px`);
        contextMenu.addClass("visible");
    });

    $("body").on("click", (e) => {
        if (e.target.offsetParent != contextMenu) {
            contextMenu.removeClass("visible");
            selectedFile = {
                path: "",
                ext: "dir",
            };
        }
    });

    document.getElementById("back-arrow").onclick = () => handleBackButton();


    window.addEventListener('message', (event) => {
        handleExternalData(event.data)
    });
    function handleExternalData(data) {
        if (data.return == "selectFile") {
            explorerMode = "sendData"
            target = data.sender;
        }
    }
    function handleBackButton() {
        if (pathHistory.length <= 1) return
        pathHistory.pop();
        openFileOrDir(pathHistory.at(-1))
    }
    function handleDirResponse(files) {

        $("#file-path").val(pathHistory.at(-1))

        if (!files.length) {
            $("#main-files").html("<p>this dir is empty</p>");
            return;
        }
        files.forEach((file) => {
            let displayValue = file.filePath.split("/").at(-1);
            let fileExt = displayValue.split(".").at(-1);
            let iconPath = file.isDir ? "default_folder" : `file_type_${fileIcons[fileExt]}`
            if (!file.isDir) {
                file.isDir = fileExt;
            }
            $("#main-files").append(
                `<span class='directory-item' onclick="openFileOrDir('${file.filePath}', '${file.isDir}')">
                    <img src='../../OperatingSystem/Icons/${iconPath}.svg' />
                    <p>${displayValue}</p>
                </span>`
            );
        });
    }
    function getDirs(filePath = "") {
        $("#main-files").empty();

        os.call('filesInDir', filePath, (res) => res.sender == "system" && handleDirResponse(res.return))
    }
    function openFileOrDir(filePath = "", isDir) {
        if (isDir == null) {
            getDirs(filePath)
            return
        }
        if (isDir === 'true') {
            getDirs(filePath);
            pathHistory.push(filePath)
            return;
        }

        if (explorerMode == "openFile")
            os.call('openFile', { mimeType: isDir, filePath: filePath })

        if (explorerMode == "sendData") {
            os.call('sendData', { target: target, data: filePath })
            os.call('closeSelf');
        }
    }

</script>